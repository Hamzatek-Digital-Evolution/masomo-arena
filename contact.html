<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Masomo Arena | Contact</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function() {
      emailjs.init("n2B1TMhtf5JbV6kiv"); // 🔑 Replace with your EmailJS Public Key
    })();
  </script>
</head>
<body class="bg-gradient-to-br from-orange-100 via-white to-blue-100 min-h-screen flex items-center justify-center p-6">

  <div class="w-full max-w-2xl bg-white shadow-2xl rounded-2xl p-8">
    <h1 class="text-3xl font-bold text-center mb-6 text-orange-600">📩 Contact</h1>

    <!-- Contact Form -->
    <form id="contactForm" class="space-y-5">

      <!-- Name -->
      <div>
        <label class="block mb-1 font-medium">Your Name</label>
        <input type="text" name="studentName" required 
          class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-orange-400">
      </div>

      <!-- Email -->
      <div>
        <label class="block mb-1 font-medium">Your Email</label>
        <input type="email" name="studentEmail" required 
          class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-400">
      </div>

      <!-- Inquiry Type -->
      <div>
        <label class="block mb-1 font-medium">Inquiry Type</label>
        <select id="inquiryType" name="inquiryType" required
          class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-orange-400">
          <option value="">-- Select --</option>
          <option value="contact">General Contact</option>
          <option value="material">Inquiry about Material</option>
        </select>
      </div>

      <!-- Material Inquiry Section -->
      <div id="materialSection" class="hidden space-y-4">
        <div>
          <label class="block mb-1 font-medium">Choose Material</label>
          <select id="materialSelect" name="materialTitle"
            class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-400">
            <option value="">-- Select Material --</option>
          </select>
        </div>

        <div>
          <label class="block mb-1 font-medium">Subject</label>
          <input type="text" id="subject" name="subject" readonly
            class="w-full border rounded-lg px-4 py-2 bg-gray-100">
        </div>

        <div>
          <label class="block mb-1 font-medium">Level</label>
          <select id="level" name="level"
            class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-400">
            <option value="">-- Select Level --</option>
          </select>
        </div>
      </div>

      <!-- Message -->
      <div>
        <label class="block mb-1 font-medium">Message</label>
        <textarea name="message" id="message" rows="4" required
          class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-orange-400"></textarea>
      </div>

      <!-- Submit -->
      <button type="submit" id="submitBtn"
        class="w-full bg-orange-500 text-white py-3 rounded-lg font-semibold hover:bg-orange-600 transition flex items-center justify-center">
        <span id="btnText">Send Message</span>
        <svg id="loadingSpinner" class="hidden ml-2 w-5 h-5 animate-spin text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
      </button>
    </form>

    <p id="statusMessage" class="mt-4 text-center font-medium"></p>

    <!-- Back Buttons -->
    <div id="backButtons" class="hidden mt-6 flex justify-center gap-4">
      <a href="materials.html" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">🔙 Back to Materials</a>
      <a href="index.html" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition">🏠 Home</a>
    </div>
  </div>

  <script>
    const inquiryType = document.getElementById("inquiryType");
    const materialSection = document.getElementById("materialSection");
    const materialSelect = document.getElementById("materialSelect");
    const subjectInput = document.getElementById("subject");
    const levelSelect = document.getElementById("level");
    const messageBox = document.getElementById("message");
    const submitBtn = document.getElementById("submitBtn");
    const btnText = document.getElementById("btnText");
    const loadingSpinner = document.getElementById("loadingSpinner");

    // Kenyan levels (CBC + JSS + SSS)
    const levels = {
      "CBC": ["Grade 1","Grade 2","Grade 3","Grade 4","Grade 5","Grade 6"],
      "JSS": ["Grade 7","Grade 8","Grade 9"],
      "SSS": ["Form 2","Form 3","Form 4"]
    };

    // Show/hide material section
    inquiryType.addEventListener("change", () => {
      materialSection.classList.toggle("hidden", inquiryType.value !== "material");
      if (inquiryType.value === "contact") messageBox.value = "";
    });

    // Load materials + preselect if ?id= provided
    async function loadMaterials() {
      const res = await fetch("materials.json");
      const materials = await res.json();

      // Fill dropdown
      materials.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m.title;
        opt.textContent = m.title;
        opt.dataset.subject = m.subject;
        materialSelect.appendChild(opt);
      });

      // Auto-select from ?id=
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      if (id) {
        const material = materials.find(m => m.id == id);
        if (material) {
          inquiryType.value = "material";
          inquiryType.dispatchEvent(new Event("change"));
          materialSelect.value = material.title;
          materialSelect.dispatchEvent(new Event("change"));
        }
      }
    }

    // Update subject + levels on material change
    materialSelect.addEventListener("change", () => {
      const selected = materialSelect.selectedOptions[0];
      if (selected) {
        subjectInput.value = selected.dataset.subject;

        levelSelect.innerHTML = `<option value="">-- Select Level --</option>`;
        [...levels.CBC, ...levels.JSS, ...levels.SSS].forEach(l => {
          const opt = document.createElement("option");
          opt.value = l;
          opt.textContent = l;
          levelSelect.appendChild(opt);
        });
      }
      messageBox.value = "";
    });

    // Auto-fill message on level select
    levelSelect.addEventListener("change", () => {
      const material = materialSelect.value;
      const subject = subjectInput.value;
      const level = levelSelect.value;

      if (material && subject && level) {
        messageBox.value = `Hello,\n\nI am interested in the material titled "${material}" for ${subject} at ${level} level. Please provide more details.\n\nThank you.`;
      }
    });

    loadMaterials();

    // Handle EmailJS submission
    document.getElementById("contactForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const statusMessage = document.getElementById("statusMessage");

      // Show loading spinner
      btnText.textContent = "Sending...";
      loadingSpinner.classList.remove("hidden");
      submitBtn.disabled = true;

      emailjs.sendForm("service_4hmzkhi", "template_0ienmlp", this)
        .then(() => {
          statusMessage.textContent = "✅ Message sent successfully!";
          statusMessage.className = "mt-4 text-center font-medium text-green-600";
          this.reset();
          materialSection.classList.add("hidden");
          document.getElementById("backButtons").classList.remove("hidden");
        }, (error) => {
          statusMessage.textContent = "❌ Failed to send. Try again.";
          statusMessage.className = "mt-4 text-center font-medium text-red-600";
          console.error("EmailJS Error:", error);
        })
        .finally(() => {
          btnText.textContent = "Send Message";
          loadingSpinner.classList.add("hidden");
          submitBtn.disabled = false;
        });
    });
  </script>

</body>
</html>
